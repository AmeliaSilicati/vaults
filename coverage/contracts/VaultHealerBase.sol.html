<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/VaultHealerBase.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> VaultHealerBase.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">65.31% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>32/49</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.5% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>6/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">40% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">67.31% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>35/52</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: GPL-3.0-or-later
pragma solidity ^0.8.4;
&nbsp;
import "./libs/OpenZeppelin.sol";
&nbsp;
import "./libs/Vault.sol";
import "./libs/IStrategy.sol";
import "./libs/IVaultHealer.sol";
import "./libs/IVaultFeeManager.sol";
&nbsp;
abstract contract VaultHealerBase is AccessControlEnumerable, ERC1155SupplyUpgradeable, IVaultHealerMain {
    using SafeERC20 for IERC20;
    using BitMaps for BitMaps.BitMap;
&nbsp;
    uint constant PANIC_LOCK_DURATION = 6 hours;
    bytes32 constant PAUSER = keccak256("PAUSER");
    bytes32 constant STRATEGY = keccak256("STRATEGY");
    bytes32 constant VAULT_ADDER = keccak256("VAULT_ADDER");
    bytes32 constant SETTINGS_SETTER = keccak256("SETTINGS_SETTER");
    bytes32 constant FEE_SETTER = keccak256("FEE_SETTER");
&nbsp;
    IVaultFeeManager internal vaultFeeManager;
    Vault.Info[] internal _vaultInfo; // Info of each vault.
    BitMaps.BitMap internal pauseMap; //Boolean pause status for each vault; true == unpaused
&nbsp;
    //vid for any of our strategies
    mapping(address =&gt; uint32) private _strats;
    uint256 internal _lock = type(uint32).max;
&nbsp;
    event AddVault(address indexed strat);
    event SetVaultFeeManager(IVaultFeeManager indexed _manager);
    event Paused(uint vid);
    event Unpaused(uint vid);
&nbsp;
    constructor(address _owner) {
        _setupRole(DEFAULT_ADMIN_ROLE, _owner);
        _setupRole(VAULT_ADDER, _owner);
        _setRoleAdmin(STRATEGY, VAULT_ADDER);
        _setupRole(PAUSER, _owner);
        _setupRole(FEE_SETTER, _owner);
        _setupRole(SETTINGS_SETTER, _owner);
        _vaultInfo.push(); //so uninitialized vid variables (vid 0) can be assumed as invalid
    }
<span class="fstat-no" title="function not covered" >    function setVaultFeeManager(IVaultFeeManager _manager) external onlyRole(FEE_SETTER) {</span>
<span class="cstat-no" title="statement not covered" >        vaultFeeManager = _manager</span>;
<span class="cstat-no" title="statement not covered" >        emit SetVaultFeeManager(_manager);</span>
    }
&nbsp;
    /**
     * @dev Add a new want to the vault. Can only be called by the owner.
     */
&nbsp;
    function addVault(address _strat) internal virtual returns (uint vid) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(!hasRole(STRATEGY, _strat)/*, "Existing strategy"*/);
        grantRole(STRATEGY, _strat); //requires msg.sender is VAULT_ADDER
&nbsp;
        IStrategy strat_ = IStrategy(_strat);
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_vaultInfo.length &lt; type(uint32).max, "too many vaults"); //absurd number of vaults
        vid = _vaultInfo.length;
        _vaultInfo.push();
        Vault.Info storage vault = _vaultInfo[vid];
        IERC20 _want = strat_.wantToken();
        vault.want = _want;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_want.totalSupply() &lt;= type(uint112).max, "incompatible total supply");
        //vault.router = strat.router();
        vault.lastEarnBlock = uint32(block.number);
        vault.minBlocksBetweenEarns = 10;
        vault.targetVid = uint32(_strats[address(strat_.targetVault())]);
        pauseMap.set(vid); //uninitialized vaults are paused; this unpauses
        
        _strats[_strat] = uint32(vid);
        emit AddVault(_strat);
    }
&nbsp;
    modifier nonReentrant() {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_lock == type(uint32).max, "reentrancy");
        _lock = 0;
        _;
        _lock = type(uint32).max;
    }
&nbsp;
    modifier reentrantOnlyByStrategy(uint vid) {
        uint lock = _lock; //saves initial lock state
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(lock == type(uint32).max || msg.sender == address(strat(lock)), "reentrancy/!strat"); //must either not be entered, or caller is the active strategy
        _lock = vid; //this vid's strategy may reenter
        _;
        _lock = lock; //restore initial state
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function setSettings(uint vid, Vault.Settings calldata _settings) external onlyRole(SETTINGS_SETTER) {</span>
<span class="cstat-no" title="statement not covered" >        strat(vid).setSettings(_settings)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function supportsInterface(bytes4 interfaceId) public view virtual override(AccessControlEnumerable, ERC1155Upgradeable) returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return AccessControlEnumerable.supportsInterface(interfaceId) || ERC1155Upgradeable.supportsInterface(interfaceId) || interfaceId == type(IVaultHealer).interfaceId;</span>
    }
&nbsp;
    function strat(uint _vid) internal virtual view returns (IStrategy);
&nbsp;
//Like OpenZeppelin Pausable, but centralized here at the vaulthealer
&nbsp;
<span class="fstat-no" title="function not covered" >    function pause(uint vid) external onlyRole("PAUSER") {</span>
<span class="cstat-no" title="statement not covered" >        _pause(vid)</span>;
    }
<span class="fstat-no" title="function not covered" >    function unpause(uint vid) external onlyRole("PAUSER") {</span>
<span class="cstat-no" title="statement not covered" >        _unpause(vid)</span>;
    }
<span class="fstat-no" title="function not covered" >    function panic(uint vid) external onlyRole("PAUSER") {</span>
<span class="cstat-no" title="statement not covered" >        require (_vaultInfo[vid].panicLockExpiry &lt; block.timestamp, "panic once per 6 hours")</span>;
<span class="cstat-no" title="statement not covered" >        _vaultInfo[vid].panicLockExpiry = uint40(block.timestamp + PANIC_LOCK_DURATION)</span>;
<span class="cstat-no" title="statement not covered" >        _pause(vid)</span>;
<span class="cstat-no" title="statement not covered" >        strat(vid).panic()</span>;
    }
<span class="fstat-no" title="function not covered" >    function unpanic(uint vid) external onlyRole("PAUSER") {</span>
<span class="cstat-no" title="statement not covered" >        _unpause(vid)</span>;
<span class="cstat-no" title="statement not covered" >        strat(vid).unpanic()</span>;
    }
    function paused(uint vid) internal view returns (bool) {
        return !pauseMap.get(vid);
    }
    modifier whenNotPaused(uint vid) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(!paused(vid), "VH: paused");
        _;
    }
<span class="fstat-no" title="function not covered" >    function _pause(uint vid) internal whenNotPaused(vid) {</span>
<span class="cstat-no" title="statement not covered" >        pauseMap.unset(vid)</span>;
<span class="cstat-no" title="statement not covered" >        emit Paused(vid);</span>
    }
<span class="fstat-no" title="function not covered" >    function _unpause(uint vid) internal {</span>
<span class="cstat-no" title="statement not covered" >        require(paused(vid) &amp;&amp; vid &gt; 0 &amp;&amp; vid &lt; _vaultInfo.length)</span>;
<span class="cstat-no" title="statement not covered" >        pauseMap.set(vid)</span>;
<span class="cstat-no" title="statement not covered" >        emit Unpaused(vid);</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Feb 04 2022 13:38:08 GMT+0200 (South Africa Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
