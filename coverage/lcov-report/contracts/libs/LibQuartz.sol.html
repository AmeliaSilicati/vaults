<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/libs/LibQuartz.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/libs/</a> LibQuartz.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/52</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/52</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: GPLv2
&nbsp;
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as published by
// the Free Software Foundation, either version 2 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.
&nbsp;
// @author Wivern for Beefy.Finance, ToweringTopaz for Crystl.Finance
// @notice This contract adds liquidity to Uniswap V2 compatible liquidity pair pools and stake.
&nbsp;
pragma solidity ^0.8.0;
&nbsp;
import {SafeERC20Upgradeable as SafeERC20} from "@openzeppelin/contracts-upgradeable/token/ERC20/utils/SafeERC20Upgradeable.sol";
import "./HardMath.sol";
import "./IStrategy.sol";
import "./IVaultHealer.sol";
import './IUniRouter.sol';
import "./IUniPair.sol";
import "./IWETH.sol";
import "./IUniFactory.sol";
&nbsp;
library LibQuartz {
    using SafeERC20 for IERC20;
    using SafeERC20 for IUniPair;
    
    uint256 constant MINIMUM_AMOUNT = 1000;
    
<span class="fstat-no" title="function not covered" >    function getRouter(IVaultHealer vaultHealer, uint vid) internal view returns (IUniRouter) {</span>
<span class="cstat-no" title="statement not covered" >        (,IStrategy strat) = vaultHealer.vaultInfo(vid);</span>
<span class="cstat-no" title="statement not covered" >        return strat.router();</span>
    }
    
<span class="fstat-no" title="function not covered" >    function getRouterAndPair(IVaultHealer vaultHealer, uint _vid) internal view returns (IUniRouter router, IStrategy strat, IUniPair pair) {</span>
<span class="cstat-no" title="statement not covered" >        IERC20 want;</span>
<span class="cstat-no" title="statement not covered" >        (want, strat) = vaultHealer.vaultInfo(_vid)</span>;
        
<span class="cstat-no" title="statement not covered" >        pair = IUniPair(address(want))</span>;
<span class="cstat-no" title="statement not covered" >        router = strat.router()</span>;
<span class="cstat-no" title="statement not covered" >        require(pair.factory() == router.factory(), 'Quartz: Incompatible liquidity pair factory')</span>;
    }
<span class="fstat-no" title="function not covered" >    function getSwapAmount(IUniRouter router, uint256 investmentA, uint256 reserveA, uint256 reserveB) internal pure returns (uint256 swapAmount) {</span>
<span class="cstat-no" title="statement not covered" >        uint256 halfInvestment = investmentA / 2;</span>
<span class="cstat-no" title="statement not covered" >        uint256 numerator = router.getAmountOut(halfInvestment, reserveA, reserveB);</span>
<span class="cstat-no" title="statement not covered" >        uint256 denominator = router.quote(halfInvestment, reserveA + halfInvestment, reserveB - numerator);</span>
<span class="cstat-no" title="statement not covered" >        swapAmount = investmentA - HardMath.sqrt(halfInvestment * halfInvestment * numerator / denominator)</span>;
    }
<span class="fstat-no" title="function not covered" >    function returnAssets(IUniRouter router, IERC20[] memory tokens) internal {</span>
<span class="cstat-no" title="statement not covered" >        IWETH weth = router.WETH();</span>
<span class="cstat-no" title="statement not covered" >        uint256 balance;</span>
        
<span class="cstat-no" title="statement not covered" >        for (uint256 i; i &lt; tokens.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            balance = tokens[i].balanceOf(address(this))</span>;
<span class="cstat-no" title="statement not covered" >            if (balance &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >                if (tokens[i] == weth) {</span>
<span class="cstat-no" title="statement not covered" >                    weth.withdraw(balance)</span>;
<span class="cstat-no" title="statement not covered" >                    (bool success,) = msg.sender.call{value: balance}(new bytes(0));</span>
<span class="cstat-no" title="statement not covered" >                    require(success, 'Quartz: ETH transfer failed')</span>;
                } else {
<span class="cstat-no" title="statement not covered" >                    tokens[i].safeTransfer(msg.sender, balance)</span>;
                }
            }
        }
    }
<span class="fstat-no" title="function not covered" >    function estimateSwap(IVaultHealer vaultHealer, uint pid, IERC20 tokenIn, uint256 fullInvestmentIn) internal view returns(uint256 swapAmountIn, uint256 swapAmountOut, IERC20 swapTokenOut) {</span>
<span class="cstat-no" title="statement not covered" >        (IUniRouter router,,IUniPair pair) = getRouterAndPair(vaultHealer, pid);</span>
        
<span class="cstat-no" title="statement not covered" >        bool isInputA = pair.token0() == tokenIn;</span>
<span class="cstat-no" title="statement not covered" >        require(isInputA || pair.token1() == tokenIn, 'Quartz: Input token not present in liquidity pair')</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        (uint256 reserveA, uint256 reserveB,) = pair.getReserves();</span>
<span class="cstat-no" title="statement not covered" >        (reserveA, reserveB) = isInputA ? (reserveA, reserveB) : (reserveB, reserveA)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        swapAmountIn = getSwapAmount(router, fullInvestmentIn, reserveA, reserveB)</span>;
<span class="cstat-no" title="statement not covered" >        swapAmountOut = router.getAmountOut(swapAmountIn, reserveA, reserveB)</span>;
<span class="cstat-no" title="statement not covered" >        swapTokenOut = isInputA ? pair.token1() : pair.token0()</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function removeLiquidity(IUniPair pair, address to) internal {</span>
<span class="cstat-no" title="statement not covered" >        pair.safeTransfer(address(pair), pair.balanceOf(address(this)))</span>;
<span class="cstat-no" title="statement not covered" >        (uint256 amount0, uint256 amount1) = pair.burn(to);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        require(amount0 &gt;= MINIMUM_AMOUNT, 'Quartz: INSUFFICIENT_A_AMOUNT')</span>;
<span class="cstat-no" title="statement not covered" >        require(amount1 &gt;= MINIMUM_AMOUNT, 'Quartz: INSUFFICIENT_B_AMOUNT')</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function optimalMint(IUniPair pair, IERC20 token0, IERC20 token1) internal returns (uint liquidity) {</span>
<span class="cstat-no" title="statement not covered" >        (token0, token1) = token0 &lt; token1 ? (token0, token1) : (token1, token0)</span>;
        
<span class="cstat-no" title="statement not covered" >        (uint112 reserve0, uint112 reserve1,) = pair.getReserves();</span>
<span class="cstat-no" title="statement not covered" >        uint totalSupply = pair.totalSupply();</span>
        
<span class="cstat-no" title="statement not covered" >        uint balance0 = token0.balanceOf(address(this));</span>
<span class="cstat-no" title="statement not covered" >        uint balance1 = token1.balanceOf(address(this));</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        uint liquidity0 = balance0 * totalSupply / reserve0;</span>
<span class="cstat-no" title="statement not covered" >        uint liquidity1 = balance1 * totalSupply / reserve1;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (liquidity0 &lt; liquidity1) {</span>
<span class="cstat-no" title="statement not covered" >            balance1 = reserve1 * balance0 / reserve0</span>;
        } else {
<span class="cstat-no" title="statement not covered" >            balance0 = reserve0 * balance1 / reserve1</span>;
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        token0.safeTransfer(address(pair), balance0)</span>;
<span class="cstat-no" title="statement not covered" >        token1.safeTransfer(address(pair), balance1)</span>;
<span class="cstat-no" title="statement not covered" >        liquidity = pair.mint(address(this))</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function hasSufficientLiquidity(IERC20 token0, IERC20 token1, IUniRouter router, uint256 min_amount) internal view returns (bool hasLiquidity) {</span>
<span class="cstat-no" title="statement not covered" >        IUniFactory factory = router.factory();</span>
<span class="cstat-no" title="statement not covered" >        IUniPair pair = IUniPair(factory.getPair(token0, token1));</span>
<span class="cstat-no" title="statement not covered" >        (uint256 reserveA, uint256 reserveB,) = pair.getReserves();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (reserveA &gt; min_amount &amp;&amp; reserveB &gt; min_amount) {</span>
<span class="cstat-no" title="statement not covered" >            return hasLiquidity = true;</span>
        } else {
<span class="cstat-no" title="statement not covered" >            return hasLiquidity = false;</span>
        }
    }
&nbsp;
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Feb 04 2022 13:38:08 GMT+0200 (South Africa Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
